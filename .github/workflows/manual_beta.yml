name: Manual Beta Release

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      CF_PROJECT_ID: "1312314"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          distribution: graalvm
          java-version: '25'
          cache: gradle
          cache-dependency-path: |
            **/*.gradle*
            **/buildscript.properties
            **/gradle-wrapper.properties
            **/gradle.lockfile
            src/main/resources/hbm_at.cfg

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Read modVersion from gradle.properties and compute tag
        id: ver
        run: |
          set -euo pipefail
          if [[ ! -f gradle.properties ]]; then
            echo "::error::gradle.properties not found in repo root"; exit 1
          fi
          MOD_VERSION=$(grep -E '^\s*modVersion\s*=' gradle.properties | sed -E 's/^\s*modVersion\s*=\s*//; s/\r$//' | xargs || true)
          if [[ -z "${MOD_VERSION}" ]]; then
            echo "::error::modVersion is empty in gradle.properties"; exit 1
          fi
          echo "MOD_VERSION=${MOD_VERSION}" >> "$GITHUB_ENV"
          echo "TAG=v${MOD_VERSION}" >> "$GITHUB_ENV"
          echo "tag=v${MOD_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build with Gradle
        run: ./gradlew build --no-daemon

      - name: Find mod jar (non-dev/non-sources/non-api)
        run: |
          set -euo pipefail
          FILE=$(ls -t build/libs/*.jar 2>/dev/null | grep -vE '(-dev|-sources|-api)\.jar$' | head -n1 || true)
          if [[ -z "${FILE}" ]]; then
            echo "::error::No release jar found in build/libs"; ls -al build/libs || true; exit 1
          fi
          echo "FILE=${FILE}" >> "$GITHUB_ENV"

      - name: Check if tag exists on origin
        id: tagcheck
        run: |
          set -euo pipefail
          if git ls-remote --exit-code --tags origin "refs/tags/${TAG}" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Push tag if it doesn't exist
        run: |
          set -euo pipefail
          git config user.name github-actions
          git config user.email github-actions@github.com

          if [[ "${{ steps.tagcheck.outputs.exists }}" == "true" ]]; then
            echo "Skipping tag push"
          else
            echo "Creating new tag ${TAG}"
            git tag "${TAG}" "${GITHUB_SHA}"
            git push origin "refs/tags/${TAG}"
          fi

      - name: Create/update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: "Beta ${{ env.TAG }}"
          prerelease: true
          generate_release_notes: true
          files: build/libs/*.jar
          overwrite_files: true
          fail_on_unmatched_files: true
          body: |
            ⚠️ **Beta-version build** — should be stable in terms of crashes but not in anything else. Use at your own risk.

            ## Which JAR should I download?

            - **NTM-CE-1.12.2-${{ env.MOD_VERSION }}.jar** — **Java 8+** (recommended for most Forge users)
            - **NTM-CE-1.12.2-${{ env.MOD_VERSION }}-java25.jar** — **Java 25+** (Cleanroom; may be more efficient)
            - **NTM-CE-1.12.2-${{ env.MOD_VERSION }}-downgraded.jar** — **Java 8+**, but **does not** shade the JVMDG `java-api` (useful if you provide a custom one)
            - **NTM-CE-1.12.2-${{ env.MOD_VERSION }}-dev.jar** — **Java 8+**, unobfuscated (for developers)
            - **NTM-CE-1.12.2-${{ env.MOD_VERSION }}-dev-java25.jar** — **Java 25+**, unobfuscated (for developers on the JVMDG/Cleanroom toolchain)

            **Commit:** `${{ github.sha }}`
            **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#      - name: Publish to CurseForge
#        env:
#          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
#          TAG: ${{ env.TAG }}
#          FILE: ${{ env.FILE }}
#        run: |
#          curl -X POST "https://minecraft.curseforge.com/api/projects/1312314/upload-file" \
#            -H "x-api-token: ${CF_API_TOKEN}" \
#            -F "metadata={
#              \"changelog\": \"See GitHub release ${TAG} for notes.\",
#              \"changelogType\": \"text\",
#              \"displayName\": \"${TAG}\",
#              \"releaseType\": \"beta\",
#              \"gameVersions\": [6756],
#            };type=application/json" \
#            -F "file=@${FILE}"

#      - name: Publish to Modrinth
#        env:
#          MODRINTH_TOKEN: ${{ secrets.MPR_TOKEN }}
#          TAG: ${{ env.TAG }}
#          FILE: ${{ env.FILE }}
#        run: |
#          curl -X POST "https://api.modrinth.com/v2/version" \
#            -H "Authorization: ${MODRINTH_TOKEN}" \
#            -F "data={
#              \"name\": \"${TAG}\",
#              \"version_number\": \"${TAG}\",
#              \"changelog\": \"See GitHub release ${TAG} for notes.\",
#              \"version_type\": \"beta\",
#              \"game_versions\": [\"1.12.2\"],
#              \"loaders\": [\"forge\"],
#              \"featured\": true,
#              \"project_id\": \"oKqJzTkl\"
#            };type=application/json" \
#            -F "file_parts[]=@${FILE}"
